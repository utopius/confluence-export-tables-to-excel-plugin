## Macro name: export-to-excel
##
## Original development by: Florian Herbel on 21/12/2013
##
## Export confluence table to excel spreed sheets using the table-to-excel plugin.
## @param tableid:title=TableId|type=string|required=false|desc=Id of the table

#if ($action.isPrintableVersion())
$body
#else
<script type="text/javascript">
if(typeof exportToEXCEL != 'function') {
    function strip_tags (input, allowed) {
        allowed = (((allowed || "") + "").toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join('');

        var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,
        commentsAndPhpTags = /<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;

        return input.replace(commentsAndPhpTags, '').replace(tags, function ($0, $1) {
                return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
        }).replace(/\r\n/gi, "");
    }

    var exportTableToText = function (table, url) {

        var obj = { rows: [] };
		$('tr').not("td div table thead tr").not("td div table tbody tr").each(function()
        {			
            currentRow = { isHeaderRow: false, cells: [] }

            jQuery(this).children().each(function ()
            {
				var isHeader = jQuery(this).is("th");
				var isCell = jQuery(this).is("td");
                if (isHeader || isCell)
                {
					if(isHeader) {
						currentRow.isHeaderRow = true;
					}
					var content = jQuery(this).text();
					var currentCell = { text: content }
                    currentRow.cells.push(currentCell);
					
					var imgChildren = jQuery(this).find('img');
					if(imgChildren.length > 0) {
						currentCell.iconUrl = imgChildren[0].src;
					}
                }
            });
            obj.rows.push(currentRow);
        });
        var json = JSON.stringify(obj);

        return json;
    }

    function exportToEXCEL(button, title, url)
    {
        var detected = false;

        var table = jQuery(button.parentNode).find("table");

        var data = exportTableToText(table, url);

        var form = document.createElement("form");
        form.setAttribute("method", "post");
        form.setAttribute("action", url);
        form.setAttribute("target", "_blank");

        var idField = document.createElement("input");
        idField.setAttribute("type", "hidden");
        idField.setAttribute("name", "id");
        idField.setAttribute("value", title);
        form.appendChild(idField);

        var dataField = document.createElement("input");
        dataField.setAttribute("type", "hidden");
        dataField.setAttribute("name", "tabledata");
        dataField.setAttribute("value", data);
        form.appendChild(dataField);

        document.body.appendChild(form);
        form.submit();

        return true;
    }
}
</script>
<div>
    $body
    <button class="ui-button ui-state-active ui-corner-all" style="HEIGHT: 30px"
            onClick="exportToEXCEL(this, 'Export to Excel', '$action.getGlobalSettings().getBaseUrl()/plugins/servlet/tabletoexcel')">Export to Excel</button>
</div>

#end